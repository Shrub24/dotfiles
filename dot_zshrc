# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$('/home/saurabhj/miniforge3/bin/conda' 'shell.bash' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "/home/saurabhj/miniforge3/etc/profile.d/conda.sh" ]; then
        . "/home/saurabhj/miniforge3/etc/profile.d/conda.sh"
    else
        export PATH="/home/saurabhj/miniforge3/bin:$PATH"
    fi
fi
unset __conda_setup
# <<< conda initialize <<<

# ZSH_THEME="powerlevel10k/powerlevel10k"

# ZFUNCDIR=${ZDOTDIR:-$HOME}/functions
# fpath=($ZFUNCDIR $fpath)
# autoload -Uz $fpath[1]/*(.:t)

source /usr/share/zsh-antidote/antidote.zsh
antidote load

# Configure OMZ plugins with scripts in conf.d.
for zlib in ${ZDOTDIR:-$HOME}/conf.d/*.zsh; source $zlib
unset zlib

alias nano="nvim"
alias edit="nvim"
alias vim="nvim"
alias vi="nvim"
alias cd="z"
alias ls='eza --color=always --color-scale=all --color-scale-mode=gradient --icons=always --group-directories-first'
alias ll='eza --color=always --color-scale=all --color-scale-mode=gradient --icons=always --group-directories-first -l --git -h'
alias la='eza --color=always --color-scale=all --color-scale-mode=gradient --icons=always --group-directories-first -a'
alias lla='eza --color=always --color-scale=all --color-scale-mode=gradient --icons=always --group-directories-first -a -l --git -h'
alias tree='eza --tree --level=2 --color=always --color-scale=all --color-scale-mode=gradient --group-directories-first --icons'
alias find="fd"
alias cat="bat"
alias grep="rg"

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

. "$HOME/.local/bin/env"
eval "$(uv generate-shell-completion zsh)"
eval "$(uvx --generate-shell-completion zsh)"

if [[ -t 0 ]]; then
  stty -ixon
fi

bindkey '^W' clear-screen
bindkey '\t\t' autosuggest-accept

export GITHUB_USERNAME=Shrub24
export EDITOR=nvim

export BAT_THEME="matugen-bat-colors"
# export FZF_DEFAULT_COMMAND="fd -uu"
# export FZF_CTRL_T_COMMAND="${FZF_DEFAULT_COMMAND} --type file"
# export FZF_ALT_C_COMMAND="${FZF_DEFAULT_COMMAND} --type directory"
# export FZF_COMPLETION_TRIGGER='~~'
export FZF_DEFAULT_OPTS="--color=fg:1,fg+:2 --bind=tab:accept
--inline-info \
--layout=reverse \
--height=60% \
--style=default \
--ansi \
--border \
--color=16 \
--preview-window=hidden
--preview '/usr/bin/lesspipe.sh {}' \
--bind '?:toggle-preview'
"

# disable sort when completing `git checkout`
zstyle ':completion:*:git-checkout:*' sort false
# set descriptions format to enable group support
# NOTE: don't use escape sequences (like '%F{red}%d%f') here, fzf-tab will ignore them
zstyle ':completion:*:descriptions' format '[%d]'
# set list-colors to enable filename colorizing
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
# force zsh not to show completion menu, which allows fzf-tab to capture the unambiguous prefix
zstyle ':completion:*' menu no
# custom fzf flags
# NOTE: fzf-tab does not follow FZF_DEFAULT_OPTS by default
zstyle ':fzf-tab:*' fzf-flags --color=fg:1,fg+:2 --bind=tab:accept --inline-info \
--layout=reverse \
--style=default \
--ansi \
--border \
--height=60% \
--color=16 \
--preview-window=hidden

# To make fzf-tab follow FZF_DEFAULT_OPTS.
# # NOTE: This may lead to unexpected behavior since some flags break this plugin. See Aloxaf/fzf-tab#455.
# zstyle ':fzf-tab:*' use-fzf-default-opts yes
# switch group using `<` and `>`
# zstyle ':fzf-tab:*' switch-group '<' '>'

fzf-zoxide-insert-widget() {
  # 1. Fetch directories from zoxide
  # 2. Use fzf with a preview window (optional, requires eza/ls)
  local selected_dir=$(zoxide query -l | fzf \
    --height=80% \
    --layout=reverse \
    --border \
    --prompt="Insert Path > " \
    --preview-window=right:50%:wrap)

  if [[ -n "$selected_dir" ]]; then
    # Check if we need to add a leading space
    # (If buffer is not empty and doesn't end with a space)
    if [[ -n "$LBUFFER" && "$LBUFFER" != *" " ]]; then
      LBUFFER+=" "
    fi
    
    # Append the directory
    LBUFFER+="${selected_dir}"
  fi

  zle redisplay
}

zle -N fzf-zoxide-insert-widget

# Binding: Keeping your preference, but standard is usually Alt-c or similar
bindkey -M viins '^f' fzf-zoxide-insert-widget
bindkey -M vicmd '^f' fzf-zoxide-insert-widget

function zvm_after_init() {
  # 1. Bind your Custom Zoxide Widget (Insert Mode)
  zvm_bindkey viins '^e' fzf-zoxide-insert-widget
  
  # 2. Restore Standard FZF bindings (Files & History)
  # These often get killed by vi-mode. We explicitly bring them back.
  
  # Ctrl+T = FZF File Search (Insert Mode)
  if zle -l fzf-file-widget; then
    zvm_bindkey viins '^t' fzf-file-widget
  fi

  # Ctrl+R = FZF History Search (Insert Mode)
  if zle -l fzf-history-widget; then
    zvm_bindkey viins '^r' fzf-history-widget
  fi
  
  # 3. Optional: Fix Autosuggestions (Accept with Ctrl+Space or Ctrl+f)
  # if type autosuggest-accept > /dev/null; then
  #   zvm_bindkey viins '^f' autosuggest-accept
  # fi
}

eval "$(zoxide init zsh)"

eval $(thefuck --alias tf)

source <(fzf --zsh)

# pnpm
export PNPM_HOME="/home/saurabhj/.local/share/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end
