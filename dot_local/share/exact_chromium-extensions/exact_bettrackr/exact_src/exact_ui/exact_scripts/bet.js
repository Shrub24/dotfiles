/*!
 * BetTrackr Chrome Extension (c) 2025 BetTrackr Pty Ltd
 * Licensed for use with a valid BetTrackr account only.
 * Reverse engineering or modification is prohibited.
 */
import{createBet as e,updateBet as t,fetchBetStatuses as n,fetchBetTypes as o,fetchBookmakerAccounts as a,_api_url as c,fetchRunners as i}from"../../shared.js";import{EventSelectManager as r}from"../../eventSelectManager.js";export async function init(){const c=document.getElementById("betForm"),i=document.getElementById("errorMessage"),m=document.getElementById("successMessage");await async function(){const e=document.getElementById("bookmaker_account_id"),t=await a();if(0==t.length){const t=document.createElement("option");return t.value="",t.textContent="- No Bookmaker Accounts -",void e.appendChild(t)}t.forEach((t=>{const n=document.createElement("option");n.value=t.bookmaker_account_id,n.textContent=t.bookmaker_name,e.appendChild(n)}))}(),await async function(){const e=await o(),t=document.getElementById("bet_type");e.forEach((e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)}))}(),await async function(){const e=await n(),t=document.getElementById("status");e.forEach((e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)}))}();const _=(new Date).toISOString().split("T")[0];document.getElementById("date_placed").value=_,document.getElementById("date_resulted").value=_,c.addEventListener("submit",(async function(n){n.preventDefault(),i.innerText="",m.innerText="";try{let n=function(e){const t=e.elements,n={};for(const e of t)e.id&&(n[e.id]=e.value);return n}(c);n.source||(n.source="Chrome Extension Manual");const o=n.bet_id>0;let a;a=o?await t(n):await e(n),a.error?(i.innerHTML=a.error.message,i.style.display="block"):m.innerHTML=o?"Bet Updated":"New bet created ["+a.id+"]",m.style.display="block"}catch(e){}})),document.getElementById("status").addEventListener("change",(function(e){d()})),document.getElementById("bookmaker_account_id").addEventListener("change",(function(e){u()}));let p="",y="",f="";const v=await async function(){return new Promise((e=>{chrome.storage.local.get("bettrackrBetData",(t=>{e(t.bettrackrBetData||null)}))}))}();v&&(function(e){for(const t in e){const n=e[t];let o=document.getElementById(t);if("bookmaker_name"!==t){if(o&&n)if("select"===o.tagName.toLowerCase()){let e=o.options;for(let t=0;t<e.length;t++)if(e[t].value==n){o.selectedIndex=t;break}}else o.value=n}else{if(o=document.getElementById("bookmaker_account_id"),!o)continue;if(e.bookmaker_account_id>0){o.value=e.bookmaker_account_id;continue}let t=o.options;for(let e=0;e<t.length;e++)if(t[e].text.trim()===n.trim()){o.selectedIndex=e;break}}}}(v),v.bet_id>0&&($("#edit-bet-id").text(v.bet_id),$("#action-text").text("Update"),$("#edit-title").removeClass("d-none")),f=v.event_display_name,v.racing_event_id>0?(p=v.racing_event_id,y=v.race_type):v.sport_event_id>0&&(p=v.sport_event_id),chrome.storage.local.remove(["bettrackrBetData"])),d(),u();let g=new r("event-container",p,y,f,!1,!1,(function(){const e=g.getValue();e>0?("sport"==g.getEventType()?($("#sport_event_id").val(e),$("#racing_event_id").val(-1)):($("#sport_event_id").val(-1),$("#racing_event_id").val(e)),$("#selection").focus(),$("#market_commission").val(g.getCommission()),s(e,g.getEventType(),!0)):($("#market_commission").val(""),$("#racing_event_id").val(-1),$("#sport_event_id").val(-1))}));await g.init(),s(g.getValue(),g.getEventType(),!1),l(),$("#selection").on("input",(function(){l()})),$("#bettrackr-spinner").remove()}function l(){let e=!1;const t=$("#selection").val().trim();$("#selection-menu .dropdown-item").each((function(){if($(this).text().toLowerCase()===t.toLowerCase())return e=!0,!1})),e?$("#message").text("Selection qualifies bet to be automatically resulted.").css("color","green"):$("#message").text("")}async function s(e,t,n){const o=$("#selection-menu");if(1>parseInt(e)||isNaN(parseInt(e)))return $("#selection-dropdown-button").prop("disabled",!0),void $(o).html("");const a=await i(e,t);if(0==a.length)$("#selection-dropdown-button").prop("disabled",!0),$("#selection").focus(),$(o).html("");else{let e="";for(const t of a)e+='<li class="runner-item"><a class="dropdown-item">'+t+"</a></li>";$("#selection-dropdown-button").prop("disabled",!1),n&&$("#selection-dropdown-button").click(),$(o).html(e),$(".runner-item .dropdown-item").on("click",(function(e){var t;e.preventDefault(),t=$(this).text(),$("#selection").val(t),$("#selection").focus(),l(),$("#stake").focus()}))}}function d(){let e=document.querySelector("#status option:checked").textContent;"Cashed Out"===e?(document.querySelector("#cashed_out_amount_container").style.display="block",document.querySelector("#cashed_out_amount").required=!0):(document.querySelector("#cashed_out_amount_container").style.display="none",document.querySelector("#cashed_out_amount").required=!1),"Pending"===e?(document.querySelector("#date_resulted_container").style.display="none",document.querySelector("#date_resulted").required=!1):(document.querySelector("#date_resulted_container").style.display="block",document.querySelector("#date_resulted").required=!0)}function u(){document.querySelector("#betfair-container").style.display="none";let e=document.querySelector("#bookmaker_account_id option:checked");e&&"Betfair"==e.textContent&&(document.querySelector("#betfair-container").style.display="block")}