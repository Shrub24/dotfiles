/*!
 * BetTrackr Chrome Extension (c) 2025 BetTrackr Pty Ltd
 * Licensed for use with a valid BetTrackr account only.
 * Reverse engineering or modification is prohibited.
 */
import{getSpinner as t,updateUser as e,fetchBetStatuses as a,fetchRecentBets as n,fetchPendingBets as o,fetchBookmakerAccounts as s,getClassFromStatus as i,updateBetStatus as l,getProfitColourClass as r,cloneAndReplace as d,getUser as c,renderTooltips as u,updateBetSelection as b,editBet as p}from"../../shared.js";let m=!0;const f=new Intl.NumberFormat("en-AU",{style:"currency",currency:"AUD",minimumFractionDigits:2,maximumFractionDigits:2});export async function init(){await v(),$("#recent-bets-ul").on("click",".list-group-item",(function(t){$(t.target).closest(".bookmaker-link").length>0||$(t.target).closest(".dropdown").length>0||$(this).data("bet-url")})),$(document).on("dblclick",".selection-text",(function(t){const e=$(this),a=e.data("bet-id");e.tooltip("hide").tooltip("dispose");const n=e.text().trim(),o=$("<input>",{type:"text",class:"form-control form-control-sm m-0",value:n});e.html(o),o.focus().select();const s=()=>{const t=o.val().trim(),s=""===t?n:t;e.html(` <a data-bet-id="${a}" class="edit-bet-link bi bi-pencil-square"></a>&nbsp;\n              <span data-bs-toggle="tooltip" title="Double click to edit.">${s}</span>`),""!=t&&b(a,t),e.tooltip({title:"Double click to edit",placement:"top",trigger:"hover"})};o.on("keydown",(function(t){"Enter"===t.key&&s()})),o.on("change focusout",(function(){s()}))})),$("#recent-btn").on("click",(function(){m=!1,$(this).addClass("active"),$("#pending-btn").removeClass("active"),_()})),$("#pending-btn").on("click",(function(){$(this).addClass("active"),$("#recent-btn").removeClass("active"),m=!0,_()})),$("#recent-bets-ul").on("click",".dropdown-item",(async function(t){const a=$(this).data("bet-id"),n=$(this).data("status");$(`#${a}-status-dropdown`).text(n),await l(a,n),await async function(){await e(),await v()}()})),$("#recent-bets-ul").on("click",".edit-bet-link",(async function(t){const e=$(this).data("bet-id");p(e)}));const a=document.getElementById("track-all-btn");a&&a.addEventListener("click",(()=>{a.disabled=!0,a.innerHTML=t(),chrome.runtime.sendMessage({action:"trackAll"}),setTimeout((()=>{a.disabled=!1,a.innerHTML="Track All"}),3e3)}))}async function v(){const t=await c();if(!t)throw Error("No bettrackrUser found in storage.");$("#pending-bet-count-value").text(t.pending_bet_count),$("#bet-count-value").text(t.bet_count),$("#roi-value").text(t.roi+"%"),$("#win-rate-value").text(t.win_rate+"%"),$("#bonus-retention-rate-value").text(t.bonus_retention_rate+"%"),$("#mug-bet-rate-value").text(t.mug_bet_rate+"%"),$("#turnover-value").text(f.format(t.turnover)),$("#total-profit-value").text(f.format(t.profit)),$("#this-month-profit-value").text((0>t.current_month_profit?"":"+")+f.format(t.current_month_profit));const e=r(t.profit),a=r(t.current_month_profit);$("#profit-card").removeClass("loss-card loss-update-animate profit-card profit-update-animate"),$("#total-profit-value").removeClass("loss-text profit-text"),$("#this-month-profit-value").removeClass("loss-text profit-text"),0>t.profit?$("#profit-card").addClass("loss-card loss-update-animate"):$("#profit-card").addClass("profit-card profit-update-animate"),$("#total-profit-value").addClass(e),$("#this-month-profit-value").addClass(a),d($("#profit-card")),async function(){const t=$("#bonus-amount-list");t.html("");const e=$("#total-bonus-amount"),a=(await s()).filter((t=>t.bonus_balance>0||t.bonus_cash_balance>0));a.sort(((t,e)=>{const a=(t.bonus_balance||0)+(t.bonus_cash_balance||0);return(e.bonus_balance||0)+(e.bonus_cash_balance||0)-a}));const n=a.reduce(((t,e)=>t+(e.bonus_balance||0)+(e.bonus_cash_balance||0)),0);a.forEach((e=>{const a=e.bonus_balance+e.bonus_cash_balance,n=e.bookmaker_name,o=e.site_url||e.bookmaker_url||"",s=$("<li>").addClass("dropdown-item d-flex justify-content-between align-items-center small"),i=$("<span>").addClass("me-2").text(n),l=$("<span>").addClass("text-end").text(""+f.format(a));if(o){const t=$("<a>").attr("href",o).attr("target","_blank").addClass("w-100 d-flex justify-content-between align-items-center");t.append(i).append(l),s.addClass("cursor-pointer"),s.append(t)}else s.append(i).append(l);t.append(s)})),e.text(n)}(),_()}async function _(){let e;if($("#recent-bets-ul").html(t()),e=m?await o():await n(),0==e.length)return void $("#recent-bets-ul").html('<li class="list-group-item list-group-item-action disabled">No bets.</li>');const s=(await a()).filter((t=>"Cashed Out"!==t)),l=e.map((t=>{const e=s.filter((e=>e!==t.status)).map((e=>`\n          <li class="small">\n            <a class="dropdown-item" href="#" data-bet-id="${t.bet_id}" data-status="${e}">${e}</a>\n          </li>\n          `)).join(""),a=i("list-group-item",t.status),n=r(t.profit);let o=t.bookmaker;return t.bookmaker_url&&(o=`<a style="cursor: default;" class="bookmaker-link"  href="${t.bookmaker_url}" target="_blank">${t.bookmaker}</a>`),`\n        <li class="list-group-item p-2 ${a}" id="${t.bet_id}-row" data-bet-id="${t.bet_id}" data-selection="${t.selection}" data-bet-url="${t.bet_url}">\n          <div class="d-flex justify-content-between align-items-end">\n            <div>\n\n            <div class="d-flex fw-semibold text-truncate selection-text" data-bet-id="${t.bet_id}"style="max-width: 190px; cursor: default;">\n              <a data-bet-id="${t.bet_id}" class="edit-bet-link bi bi-pencil-square"></a>&nbsp;\n              <span data-bs-toggle="tooltip" title="Double click to edit.">${t.selection}</span>\n            </div>\n              <div class="small">${o} â€¢ $${t.stake} @ ${t.odds}</div>\n            </div>\n            <div class="d-flex flex-column align-items-end">\n              <div class="small text-muted">${t.bet_type}</div>\n              <div class="d-flex align-items-center">\n                <span class="small me-1 ${n}" data-bs-toggle="tooltip" title="Profit">${f.format(t.profit)}</span>\n                <div class="dropdown">\n                  <button class="badge bg-primary rounded-pill dropdown-toggle border-0 text-truncate" style="cursor: default; max-width:112px" type="button" id="${t.bet_id}-status-dropdown" data-bs-toggle="dropdown" aria-expanded="false">\n                    ${t.status}\n                  </button>\n                  <ul class="dropdown-menu dropdown-menu-end text-end p-0" style="min-width: auto;" aria-labelledby="${t.bet_id}-status-dropdown">\n                    ${e}\n                  </ul>\n                </div>\n              </div>\n            </div>\n          </div>\n        </li>\n      `})).join("");$("#recent-bets-ul").html(l),u()}