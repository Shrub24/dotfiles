/*!
 * BetTrackr Chrome Extension (c) 2025 BetTrackr Pty Ltd
 * Licensed for use with a valid BetTrackr account only.
 * Reverse engineering or modification is prohibited.
 */
import{isLoggedIn as t,logout as e,fetchBookmakerAccounts as n,updateBookmakerBalance as a,updateUser as o,getSpinner as s,renderTooltips as c,checkLatestVersion as l}from"../shared.js";const r={bet:"bet.html",home:"home.html",login:"login.html",settings:"settings.html",bookmakers:"bookmakers.html",calendar:"calendar.html",changelog:"changelog.html"},i=new Intl.NumberFormat("en-AU",{style:"currency",currency:"AUD",minimumFractionDigits:2,maximumFractionDigits:2});async function m(){const t=$("#bookmakers-list");t.html(s());const e=await n();if(0==e.length)return $("#total-bookmaker-balance").text("No Bookmaker Accounts."),void t.html('<p class="text-center my-2"><a target="_blank" href="https://bettrackr.com.au/app.pma/bookmakers">Add Bookmakers</a></p>');const o=e.reduce(((t,e)=>t+e.balance),0);$("#total-bookmaker-balance").text(i.format(o)),t.html(""),e.forEach((async e=>{const n=e.site_url||e.bookmaker_url||"";let o=e.bookmaker_name;n&&(o='<a target="_blank" href="'+n+'">'+e.bookmaker_name+"</a>");const s=$(`\n      <li class="list-group-item d-flex justify-content-between align-items-center">\n        <span class="text-truncate">${o}</span>\n        <div class="input-group input-group-sm" style="width:120px;">\n          <span class="input-group-text">$</span>\n          <input\n            class="form-control form-control-sm"\n            type="number"\n            value="${e.balance}"\n            min="0"\n            step="0.01"\n            max="99999"\n            placeholder="0.00"\n            />\n        </div>\n      </li>`);s.find("input").on("change",(async function(){const t=parseFloat(this.value);let n="Balance updated";const o=(await a(e.bookmaker_account_id,t)).success;$("#balance-updated-msg").removeClass("text-success text-danger"),o?(m(),$("#balance-updated-msg").addClass("text-success")):(n="Unable to update balance",$("#balance-updated-msg").addClass("text-danger")),$("#balance-updated-msg").html(n),$("#balance-updated-msg").show(),setTimeout((()=>{$("#balance-updated-msg").hide()}),"1000")})),t.append(s)}))}async function p(n){if(!await t()&&"login"!=n)return void(location.href="./layout.html?page=login");if($("#content-spinner").html(s()),"bet"==n||"home"==n)try{await o()}catch(t){if(401===t.status||403===t.status)return $("#content-spinner").html(""),void await e();throw $("#content").html(t),$("#content-spinner").html(""),t}"login"!=n&&($(document).on("click","#walletDropdownButton",(function(t){m()})),$(document).on("click","#walletDropdown .btn-close",(function(t){const e=document.getElementById("walletDropdown");(bootstrap.Dropdown.getInstance(e)||new bootstrap.Dropdown(e)).hide()})));const a="./pages/"+r[n]||r.home;try{const t=await fetch(a),o=await t.text();$("#content").html(o);const s=`./scripts/${n}.js`,l=await import(s);if("function"==typeof l.init)try{await l.init()}catch(t){if(401===t.status||403===t.status)return void await e();throw $("#content").html(t),$("#content-spinner").html(""),t}$("#content-spinner").html(""),$("#content").removeClass("d-none"),c()}catch(t){}}await l()?chrome.storage.local.get("page",(t=>{const e=new URLSearchParams(window.location.search);p(t.page||e.get("page")||"home"),chrome.storage.local.remove("page")})):location.href="./pages/oldVersion.html";