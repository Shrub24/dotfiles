const editIcon='\n<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">\n  <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>\n  <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>\n</svg>\n',checkIcon='\n<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">\n  <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/>\n</svg>\n',walletIcon='\n<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-wallet2" viewBox="0 0 16 16">\n  <path d="M12.136.326A1.5 1.5 0 0 1 14 1.78V3h.5A1.5 1.5 0 0 1 16 4.5v9a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 13.5v-9a1.5 1.5 0 0 1 1.432-1.499zM5.562 3H13V1.78a.5.5 0 0 0-.621-.484zM1.5 4a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5z"/>\n</svg>\n';class BtnManager{constructor(t,e){this.$parentElement=t,this.options=e,this.uuid=crypto.randomUUID(),this.buttonContainerID="container-"+this.uuid,this.hideTimeout=null,this.showTimeout=null,this.progressInterval=null,this.activePopover=null,this.popoverData=null}parentExists(){return this.$parentElement&&this.$parentElement.length>0}isAttached(){return this.$parentElement.find(".bettrackr-btn-container").length>0}remove(){this.clearAllPopoverTimeouts(),this.getButtonContainer$().remove()}getButtonContainer$(){return $("#"+this.buttonContainerID)}getParentContainer$(){return $(this.$parentElement)}hideMessage(){this.getMessage$().css({display:"none"})}showMessage(){this.getMessage$().css({display:"block"})}getMessage$(){return $("#msg-"+this.uuid)}getTrackButton$(){return $("#btn-"+this.uuid)}clearAllButtons(){$(".bettrackr-btn-container").remove()}enable(){const t=this.getButtonContainer$();0!==t.length&&(t.find("#btn-text-"+this.uuid).html("Track with BetTrackr"),this.getTrackButton$().prop("disabled",!1))}disable(t,e){const s=this.getButtonContainer$();if(0===s.length)return;const i=s.find("#btn-text-"+this.uuid),n=`<div style="display: flex; align-items: center;">${checkIcon}<span>&nbsp;${t}</span></div>`;i.html(n),this.getTrackButton$().prop("disabled",!0),e&&e>0&&setTimeout((()=>{this.getTrackButton$().prop("disabled",!1)}),e)}displayMessage(t,e){if(0===this.getButtonContainer$().length)return;const s=this.getMessage$();this._messageTimeout&&(clearTimeout(this._messageTimeout),this._messageTimeout=null),s.stop(!0,!0).show(),s.html(t),s.removeClass("text-danger text-success"),s.addClass(e?"text-danger":"text-success"),this.showMessage(),this._messageTimeout=setTimeout((()=>{s.fadeOut((()=>this.hideMessage())),this._messageTimeout=null}),5e3)}attach(t,e,s){if(!this.parentExists())return;if(this.isAttached())return;const i=this._createButton$(t,s);this.$parentElement.append(i),this._setupHoverPopover(e)}trackAll(){$(".btn-bettrackr-track").each((function(t,e){$(e).is(":disabled")||$(e).click()}))}_createButton$(t,e){const s=$("<div>").attr("id",this.buttonContainerID).addClass("bettrackr-btn-container"),i=$('<button type="button" id="btn-'+this.uuid+'">').html(`<div id="btn-text-${this.uuid}">Track with BetTrackr</div>`).addClass("bettrackr-button btn-bettrackr-track").attr("title","Track Bet").on("click",(()=>t(this))),n=$('<button type="button" id="reconcile-btn-'+this.uuid+'">').html(`<div id="reconcile-btn-text-${this.uuid}">${walletIcon}</div>`).addClass("bettrackr-button btn-bettrackr-balance").attr("title","Update bookmaker balance").on("click",(()=>e(this))),o=$('<div role="group">').addClass("bettrackr-button-group").append(n).append(i),a=$("<div>").attr("id","msg-"+this.uuid).addClass("bettrackr-message");return s.append(o).append(a),s}_setupHoverPopover(t){const e=$("#btn-"+this.uuid),s="popover-"+this.uuid,i="indicator-"+this.uuid,n=$('<button style="width: 100%" type="button" id="edit-btn-'+this.uuid+'">').html(`<div style="display: flex; align-items: center;">${editIcon}<span>&nbsp;Edit</span></div>`).addClass("bettrackr-button btn-bettrackr-edit").on("click",(()=>t(this))),o=$(`\n      <div class="bettrackr-popover top" id="${s}" style="display: none">\n        <div class="popover-content">\n          <div class="popover-text">Loading...</div>\n        </div>\n      </div>\n    `).append(n),a=$(`\n      <div class="bettrackr-hover-indicator" id="${i}">\n        <div class="progress-circle"></div>\n        <div class="countdown-text"></div>\n      </div>\n    `);e.append(a),this.getButtonContainer$().append(o),e.on("mouseenter",(()=>{this.startHoverSequence(e,o,a)})),e.on("mouseleave",(()=>{this.cancelHoverSequence(o,a)})),o.on("mouseenter",(()=>{this.clearHideTimeout()})),o.on("mouseleave",(()=>{this.hidePopover(o,a)}))}startHoverSequence(t,e,s){this.clearAllPopoverTimeouts(),s.addClass("show");let i=0;s.find(".countdown-text");const n=s.find(".progress-circle");this.progressInterval=setInterval((()=>{i+=10;const t=i/100*360;n.css("background",`conic-gradient(#6ee81f ${t}deg, transparent ${t}deg)`),100>i||(clearInterval(this.progressInterval),this.loadAndShowPopover(e,s))}),100)}async loadAndShowPopover(t,e){if(!await isLoggedIn())return this.displayMessage("Please Login.",!0),void chrome.runtime.sendMessage({action:"openBetPage",bet_data:{}});if(!t.hasClass("show"))try{const s=await extractData(this),i=t.find(".popover-text");s?i.html(this.renderBet(s)):i.html("No bet data found"),this.showPopover(t,e)}catch(s){t.find(".popover-text").html("Error loading bet data"),this.showPopover(t,e)}}renderBet(t){let e=`<div class="">${t.event.success?t.event.event.event_display_name:"No event details."}</div>`,s=new Date;t.date_placed&&(s=new Date(t.date_placed));let i="";return"betfair"==t.bookmaker_name.toLowerCase()&&t.event.success&&(i=`<div>Comission: <strong>${t.event.event.commission||0}%</strong></div>`),`\n          <div class="">\n            <div style="display: flex; justify-content: space-between">\n              <div class="">${getDisplayDate(s)}</div>\n              <div class="">${t.bet_type}</div>\n            </div><br/>\n            <div class="" title="${t.eventDisplay}">${e}</div>\n            ${i}<br/>\n            <div class="" title="${t.selection}">Selection: <strong>${t.selection}</strong></div>\n            <div class="">Stake: <strong>${formatCurrency(t.stake)}</strong></div>\n            <div>Odds: <strong>${t.odds}</strong></div>\n          </div>\n      `}cancelHoverSequence(t,e){this.clearAllPopoverTimeouts(),e.removeClass("show"),this.hidePopover(t,e,!1),setTimeout((()=>{e.hasClass("show")||(e.find(".countdown-text"),e.find(".progress-circle").css("background","conic-gradient(var(--bettrackr-green) 0deg, transparent 0deg)"))}),200)}showPopover(t,e){this.activePopover&&this.activePopover[0]!==t[0]&&this.activePopover.removeClass("show").hide(),this.activePopover=t,e.removeClass("show"),setTimeout((()=>{t.show().addClass("show")}),100)}hidePopover(t,e,s=!1){const i=s?0:150;this.hideTimeout=setTimeout((()=>{t.removeClass("show"),e.removeClass("show"),setTimeout((()=>{t.hide()}),300),this.activePopover&&this.activePopover[0]===t[0]&&(this.activePopover=null)}),i)}clearHideTimeout(){this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null)}clearAllPopoverTimeouts(){this.clearHideTimeout(),this.showTimeout&&(clearTimeout(this.showTimeout),this.showTimeout=null),this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null)}}