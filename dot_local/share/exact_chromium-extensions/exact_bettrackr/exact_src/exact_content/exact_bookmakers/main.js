/*!
 * BetTrackr Chrome Extension (c) 2025 BetTrackr Pty Ltd
 * Licensed for use with a valid BetTrackr account only.
 * Reverse engineering or modification is prohibited.
 */
const sourceMap={"www.sportsbet.com.au":sportsbet,"www.tab.com.au":tab,"www.betfair.com.au":betfair,"www.neds.com.au":neds,"www.betr.com.au":betr,"pointsbet.com.au":pointsbet,"www.tabtouch.mobi":tabtouch,"www.tabtouch.com.au":tabtouch,"www.ladbrokes.com.au":ladbrokes,"www.unibet.com.au":unibet},currentHost=window.location.hostname,bookmaker=sourceMap[currentHost],BOOKMAKER_NAME=bookmaker.bookmaker_name;let managerMap=new WeakMap;async function reconcileBookmakerBalance(e){const t=$(bookmaker.balance);if(1>t.length)return void e.displayMessage("Balance element not found",!0);const a=t.text(),n=parseFloat(a.replace("$","").replace(",",""))||-1;-1!==n?await updateBookmakerBalance(e,n):e.displayMessage("Unable to set balance",!0)}async function waitForElement(e,t=5e3){return new Promise(((a,n)=>{const o=document.querySelector(e);if(o)return a(o);const s=new MutationObserver((()=>{const t=document.querySelector(e);t&&(s.disconnect(),a(t))}));s.observe(document,{childList:!0,subtree:!0}),setTimeout((()=>{s.disconnect(),n(Error(`Element ${e} not found within timeout`))}),t)}))}async function isLoggedIn(){return new Promise(((e,t)=>{chrome.runtime.sendMessage({action:"isLoggedIn"},(a=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(a)}))}))}async function updateBookmakerBalance(e,t){chrome.runtime.sendMessage({action:"updateBookmakerBalance",data:{bookmaker:BOOKMAKER_NAME,balance:t}},(a=>{a.success?e.displayMessage(BOOKMAKER_NAME+" balance set to: $"+t,!1):e.displayMessage("Error updating bookmaker balance",!0)}))}function checkHost(){return currentHost in sourceMap}function processPages(){const e=bookmaker.pages,t=Object.entries(e).map((([e,t])=>({page:e,options:t}))),a=window.location.pathname.split("/");t.forEach((({page:e,options:t})=>{const n="*"===e,o=e===window.location.pathname.split("/").pop(),s="market"===e&&a.includes("market");(n||o||s)&&waitForElementsContinuously(t.button,t.filter,(function(e){const a=new BtnManager(e,t);a.attach(saveBet,editBet,reconcileBookmakerBalance),managerMap.set(e[0],a)}))}))}function isNavigationModalVisible(){return $(".nav-modal-dialog.modal-dialog:visible").length>0}function waitForElementsContinuously(e,t,a){!function n(){const o=$(e.trim());o.length&&o.each((function(){const n=$(this),o=!0===n.data("bettrackr-processed"),s="function"!=typeof t||t(n,e);if(o&&!s){const e=managerMap.get(n[0]);return n.removeData("bettrackr-processed"),e.remove(),void managerMap.delete(n[0])}!o&&s&&(n.data("bettrackr-processed",!0),a(n))})),setTimeout(n,100)}()}async function saveBet(e){if(!await isLoggedIn())return e.displayMessage("Please Login.",!0),void chrome.runtime.sendMessage({action:"openBetPage",bet_data:{}});const t=await extractData(e);t.source="Chrome Extension ("+t.bookmaker_name+")",e.disable("Tracking..."),chrome.runtime.sendMessage({action:"createBet",data:t},(t=>{t.success?(e.displayMessage(t.message,!1),e.disable("Bet Tracked",4e3)):(e.displayMessage(t.error.message,!0),(t.error.message+"").includes("Bet already tracked")?e.disable("Bet Tracked"):e.enable())}))}async function extractData(e){const t=e.options.fields,a=(await Promise.all(Object.keys(t).map((async a=>{const n=t[a];let o=await n(e.getParentContainer$());return"stake"!==a&&"odds"!==a&&"cashed_out_amount"!==a||o&&(o=parseFloat(o.toString().replace("$",""))||0),{field:a,value:o}})))).reduce(((e,{field:t,value:a})=>(e[t]=a,e)),{});a.bookmaker_name=BOOKMAKER_NAME;const n=a.is_racing;let o={};return n&&(a.betfair_market_id||a.runner)?(o=await fetchEvent(!0,a.betfair_market_id,a.track,a.runner,"",a.event_date,null,a.bookmaker_name),o.success&&(a.racing_event_id=o.event.racing_event_id)):n||!a.betfair_market_id&&!a.event_name||(o=await fetchEvent(!1,a.betfair_market_id,"",a.selection,a.event_name,a.event_date,a.sport,a.bookmaker_name),o.success&&(a.sport_event_id=o.event.sport_event_id)),o.success&&(a.selection=o.runner||a.selection,a.event_display_name=o.event.event_display_name,n?(a.racing_event_id=o.event.racing_event_id,a.race_type=o.event.race_type):a.sport_event_id=o.event.sport_event_id),a.event=o,"betfair"==a.bookmaker_name.toLowerCase()&&(a.event.success&&(a.market_commission=a.event.event.commission),a.commission_discount=await getUserCommissionDiscount()),a}function sendMessagePromise(e){return new Promise(((t,a)=>{try{chrome.runtime.sendMessage(e,(e=>{const n=chrome.runtime.lastError;if(n)return a(n);t(e)}))}catch(e){a(e)}}))}async function fetchEvent(e,t,a,n,o,s,r,i){return sendMessagePromise({action:"fetchEvent",data:{is_racing:e,betfair_market_id:t,track:a,runner:n,event_name:o,event_date:s,sport:r,bookmaker:i}})}async function getUser(){return sendMessagePromise({action:"getUser"})}async function getUserCommissionDiscount(){return(await getUser()).betfair_commission_discount}async function editBet(e){if(!await isLoggedIn())return e.displayMessage("Please Login.",!0),void chrome.runtime.sendMessage({action:"openBetPage",bet_data:{}});const t=await extractData(e);chrome.runtime.sendMessage({action:"openBetPage",bet_data:t})}chrome.runtime.onMessage.addListener(((e,t,a)=>{"trackAll"===e.action&&trackAll()}));let mainObserver,lastUrl=location.href;function main(){checkHost()&&bookmaker&&processPages()}main(),mainObserver&&mainObserver.disconnect(),mainObserver=new MutationObserver((()=>{const e=location.href;isNavigationModalVisible()||e!==lastUrl&&(lastUrl=e,main())})),mainObserver.observe(document,{subtree:!0,childList:!0});